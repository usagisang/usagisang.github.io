<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android上的设备管理 | Milky Way</title><meta name=keywords content="android"><meta name=description content="
https://source.android.com/docs/devices/admin
https://developer.android.com/work/guide
https://developers.google.com/android/work/play/emm-api/prov-devices

本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。
关键术语

Device Policy Controller：设备政策控制器，简称 DPC
Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO
Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO

设备管理方案
一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。"><meta name=author content="kigumi"><link rel=canonical href=https://usagisang.github.io/posts/android%E4%B8%8A%E7%9A%84%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/><meta name=google-site-verification content="gZ_y5FZMr0xyqn2GYGweWkUiR91xeh6QD1rotAljnIQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.e2f058358ec52eb22fc8c057969ec5a153a5fc97b6118dd28aaf318da6f96ea7.css integrity="sha256-4vBYNY7FLrIvyMBXlp7FoVOl/Je2EY3Siq8xjab5bqc=" rel="preload stylesheet" as=style><link rel=icon href=https://usagisang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://usagisang.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://usagisang.github.io/favicon.ico><link rel=apple-touch-icon href=https://usagisang.github.io/favicon.ico><link rel=mask-icon href=https://usagisang.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://usagisang.github.io/posts/android%E4%B8%8A%E7%9A%84%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Noto+Sans+SC:wght@100..900&display=swap" rel=stylesheet><script>document.addEventListener("DOMContentLoaded",()=>{var e,n=document.body.textContent;const t=document.querySelector(".main"),s=!0;if(s&&n.match(/(?:\$|\\begin\{.*?})/)){const n=setTimeout(()=>{t.classList.add("visible")},3e3);window.MathJax||(window.MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]],processEscapes:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code","annotation","annotation-xml"]},startup:{typeset:!1,pageReady:()=>MathJax.startup.defaultPageReady().then(()=>{MathJax.typeset(),t.classList.add("visible"),clearTimeout(n)}).catch(e=>{console.error("MathJax rendering failed:",e)})}}),e=document.createElement("script"),e.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js",e.setAttribute("async",""),document.head.appendChild(e)}else t.classList.add("visible")})</script><meta property="og:url" content="https://usagisang.github.io/posts/android%E4%B8%8A%E7%9A%84%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/"><meta property="og:site_name" content="Milky Way"><meta property="og:title" content="Android上的设备管理"><meta property="og:description" content=" https://source.android.com/docs/devices/admin
https://developer.android.com/work/guide
https://developers.google.com/android/work/play/emm-api/prov-devices
本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。
关键术语
Device Policy Controller：设备政策控制器，简称 DPC Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO 设备管理方案 一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-18T00:00:00+00:00"><meta property="article:tag" content="Android"><meta property="og:image" content="https://usagisang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://usagisang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android上的设备管理"><meta name=twitter:description content="
https://source.android.com/docs/devices/admin
https://developer.android.com/work/guide
https://developers.google.com/android/work/play/emm-api/prov-devices

本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。
关键术语

Device Policy Controller：设备政策控制器，简称 DPC
Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO
Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO

设备管理方案
一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://usagisang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android上的设备管理","item":"https://usagisang.github.io/posts/android%E4%B8%8A%E7%9A%84%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android上的设备管理","name":"Android上的设备管理","description":" https://source.android.com/docs/devices/admin\nhttps://developer.android.com/work/guide\nhttps://developers.google.com/android/work/play/emm-api/prov-devices\n本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。\n关键术语\nDevice Policy Controller：设备政策控制器，简称 DPC Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO 设备管理方案 一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。\n","keywords":["android"],"articleBody":" https://source.android.com/docs/devices/admin\nhttps://developer.android.com/work/guide\nhttps://developers.google.com/android/work/play/emm-api/prov-devices\n本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。\n关键术语\nDevice Policy Controller：设备政策控制器，简称 DPC Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO 设备管理方案 一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。\nDPC 应用的运行模式 Android 提供了以下三种设备管理模式，其中一种已在 9.0 后废弃，无法再使用。\nDevice Owner（设备所有者）\nDPC 应用成为设备所有者，用于管理整个设备。这是权限最高的模式，一旦开启，除非 DPC 应用主动注销自己，否则只能通过恢复出厂设置来重置。\nProfile Owner（工作配置所有者）\nDPC 应用被设置为 Profile Owner。启用这个模式后，相当于系统开启一个额外的工作分区，工作分区和个人分区的内容互不影响，DPC 应用只有管理工作分区的权限。该设备依然可以用于个人用途。此类设备管理主要用于个人和组织同时持有的设备。权限比 Device Owner 低。\nDevice Admin，此模式在 9.0 中被废弃并在 10.0 中完全移除相应功能。\n成为Device Owner 前提条件：\n需要成为 Device Owner 的应用必须包含继承android.app.admin.DeviceAdminReceiver的组件。假设自定义的组件名为TestReceiver。\n通过二维码，必须在开机向导结束前设置。\nGoogle 没有具体提供采用这种方式激活成为 Device Owner 的详细步骤，据测试，使用下述 intent 可以启动ManagedProvisioning框架\nam start -a android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE --ecn android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME \"packageName/.TestReceiver\" 通过 adb shell\n使用如下命令：\nadb shell dpm set-device-owner packageName/.TestReceiver 通过 NFC\n通过二维码注册为 Device Owner 根据Google Play EMM API，我们可以总结出通过二维码注册 Device Owner 的主要流程。\n准备二维码 二维码的内容应当是一个采用 UTF-8 编码的 JSON 字符串，内部包含一些参数。这些参数包括：\n必须\nandroid.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\n如果未安装 DPC，则必须提供下载路径和校验码\nandroid.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\nandroid.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\n更多参数请参考上述资料。\n一个可用的二维码内容的示例：\n{ \"android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\": \"com.emm.android/com.emm.android.DeviceAdminReceiver\", \"android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\": \"gJD2YwtOiWJHkSMkkIfLRlj-quNqG1fb6v100QmzM9w=\", \"android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\": \"https://path.to/dpc.apk\", \"android.app.extra.PROVISIONING_SKIP_ENCRYPTION\": false, \"android.app.extra.PROVISIONING_WIFI_SSID\": \"GuestNetwork\", \"android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\": { \"dpc_company_name\": \"Acme Inc.\", \"emm_server_url\": \"https://server.emm.biz:8787\", \"another_custom_dpc_key\": \"dpc_custom_value\" } } 扫码 扫码模块必须是开机向导的一部分，开机向导完成后就无法通过二维码的方式设置 Device Owner。\n扫码模块在解析完毕 JSON 内所有参数后，发送一个 Intent。Intent 的 action 应当是DevicePolicyManager#ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE，extra则携带解析 JSON 获得的参数。\nManagedProvisioning 相应的 Intent 将会启动ManagedProvisioning应用。如果 DPC 应用尚未安装到设备上，那么ManagedProvisioning会负责下载并安装 DPC 应用，前提是提供了下载路径和校验码这两个关键参数。\n当应用已安装到设备上，ManagedProvisioning接下来的行为与 Android 版本相关。我们只讨论 Android 10 及以上的平台版本。\n在 Android 10 及以上的平台版本，ManagedProvisioning将会交由 DPC 应用来决定（实际上是要求用户决定）成为 Device Owner 还是 Profile Owner。ManagedProvisioning将会进行一次startActivityForResult，ACTION 为DevicePolicyManager#ACTION_GET_PROVISIONING_MODE。\nDPC应用 一般来说收到 Intent 后，DPC 应用应该展示一个界面，让用户选择 DPC 应用成为 Device Owner 或 Profile Owner ，结果回传的 key 可以参阅DevicePolicyManager#ACTION_GET_PROVISIONING_MODE的文档。\n最后的步骤 ManagedProvisioning将会完成使能 Device Owner 或 Profile Owner 的最后步骤。\n设备配置后，DPC 会收到以下这些广播：\nDeviceAdminReceiver#ACTION_READY_FOR_USER_INITIALIZATION DeviceAdminReceiver#ACTION_PROFILE_PROVISIONING_COMPLETE 并且 DPC 的 DevicePolicyManager#ACTION_ADMIN_POLICY_COMPLIANCE 处理程序会被启动。\n低平台版本的行为\n在 Android 9 及以下的平台版本，ManagedProvisioning将会自动判断到底将 DPC 应用设置为 Device Owner 还是 Profile Owner。判断的依据是ProvisioningParams#provisioningAction\n// packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/preprovisioning/PreProvisioningController.java // Android 9 public boolean isProfileOwnerProvisioning() { // mParams类型为ProvisioningParams return mUtils.isProfileOwnerAction(mParams.provisioningAction); } // packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/common/Utils.java // Android 9 public final boolean isProfileOwnerAction(String action) { return ACTION_PROVISION_MANAGED_PROFILE.equals(action) || ACTION_PROVISION_MANAGED_USER.equals(action); } public final boolean isDeviceOwnerAction(String action) { return ACTION_PROVISION_MANAGED_DEVICE.equals(action) || ACTION_PROVISION_MANAGED_SHAREABLE_DEVICE.equals(action); } 这个 ACTION 一般来说和启动它的 Intent 的 ACTION 一致，但有几个特殊的 ACTION 会被转换，ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE就是其中一例：\n// packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/common/Utils.java // Android 9 public String mapIntentToDpmAction(Intent intent) throws IllegalProvisioningArgumentException { // ... switch (intent.getAction()) { case ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE: dpmProvisioningAction = ACTION_PROVISION_MANAGED_DEVICE; break; } // ... } 因此，启动 DPC 应用这一步将被省略，并且也不会发送ACTION 为DevicePolicyManager#ACTION_ADMIN_POLICY_COMPLIANCE 的 Intent。\n流程梳理 我们的主要分析目标是ManagedProvisioning这个应用，它是 AOSP 的一部分，与设备管理功能强关联。\n开始 流程的第一步是发送一个 Intent 以启动ManagedProvisioning，ACTION 有四种选择，这些ACTION 均可在DevicePolicyManager中被找到：\nandroid.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE android.app.action.PROVISION_FINANCED_DEVICE android.app.action.PROVISION_MANAGED_PROFILE android.app.action.PROVISION_MANAGED_DEVICE 这四个 ACTION 到底有什么区别呢？主要的区别在于，前两个 ACTION 是给系统应用使用的；后两个 ACTION 是给 DPC 应用使用的，但在 API 31 （Android 12）及以后，PROVISION_MANAGED_DEVICE被弃用了。DPC 应用现在只能主动成为 Profile Owner，ManagedProvisioning虽然还会响应PROVISION_MANAGED_DEVICE ，但是添加了一个条件分支阻止进一步使能为 DO。\n携带的 extra 参数的要求可以参考相应 ACTION 的文档。一般来说都需要携带android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME这个参数来指明组件。\n测试脚本：\nam start -a android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE --ecn android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME \"com.afwsamples.testdpc/.DeviceAdminReceiver\" PreProvisioningActivity 从清单中很容易能够发现，PreProvisioningActivity响应了ACTION_PROVISION_MANAGED_PROFILE和ACTION_PROVISION_MANAGED_DEVICE：\n","wordCount":"4405","inLanguage":"zh","image":"https://usagisang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-06-18T00:00:00Z","dateModified":"2024-06-18T00:00:00Z","author":{"@type":"Person","name":"kigumi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://usagisang.github.io/posts/android%E4%B8%8A%E7%9A%84%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/"},"publisher":{"@type":"Organization","name":"Milky Way","logo":{"@type":"ImageObject","url":"https://usagisang.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://usagisang.github.io/ accesskey=h title="Milky Way (Alt + H)"><img src=https://usagisang.github.io/favicon.ico alt aria-label=logo height=35>Milky Way</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://usagisang.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://usagisang.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Android上的设备管理</h1><div class=post-meta><span title='2024-06-18 00:00:00 +0000 UTC'>2024-06-18</span>&nbsp;·&nbsp;<span>9 分钟</span>&nbsp;·&nbsp;<span>kigumi</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86%e6%96%b9%e6%a1%88 aria-label=设备管理方案>设备管理方案</a></li><li><a href=#dpc-%e5%ba%94%e7%94%a8%e7%9a%84%e8%bf%90%e8%a1%8c%e6%a8%a1%e5%bc%8f aria-label="DPC 应用的运行模式">DPC 应用的运行模式</a></li><li><a href=#%e6%88%90%e4%b8%badevice-owner aria-label="成为Device Owner">成为Device Owner</a></li><li><a href=#%e9%80%9a%e8%bf%87%e4%ba%8c%e7%bb%b4%e7%a0%81%e6%b3%a8%e5%86%8c%e4%b8%ba-device-owner aria-label="通过二维码注册为 Device Owner">通过二维码注册为 Device Owner</a><ul><li><a href=#%e5%87%86%e5%a4%87%e4%ba%8c%e7%bb%b4%e7%a0%81 aria-label=准备二维码>准备二维码</a></li><li><a href=#%e6%89%ab%e7%a0%81 aria-label=扫码>扫码</a></li><li><a href=#managedprovisioning aria-label=ManagedProvisioning>ManagedProvisioning</a></li><li><a href=#dpc%e5%ba%94%e7%94%a8 aria-label=DPC应用>DPC应用</a></li><li><a href=#%e6%9c%80%e5%90%8e%e7%9a%84%e6%ad%a5%e9%aa%a4 aria-label=最后的步骤>最后的步骤</a></li></ul></li><li><a href=#%e6%b5%81%e7%a8%8b%e6%a2%b3%e7%90%86 aria-label=流程梳理>流程梳理</a><ul><li><a href=#%e5%bc%80%e5%a7%8b aria-label=开始>开始</a></li><li><a href=#preprovisioningactivity aria-label=PreProvisioningActivity>PreProvisioningActivity</a></li><li><a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e8%83%bd%e4%b8%ba-owner aria-label="如何使能为 Owner">如何使能为 Owner</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p><a href=https://source.android.com/docs/devices/admin>https://source.android.com/docs/devices/admin</a></p><p><a href=https://developer.android.com/work/guide>https://developer.android.com/work/guide</a></p><p><a href=https://developers.google.com/android/work/play/emm-api/prov-devices>https://developers.google.com/android/work/play/emm-api/prov-devices</a></p></blockquote><p>本文提到的“设备管理”并不面向终端用户，而是一种支持企业管理、监控和保护所有用于工作的移动设备的实际需要而产生的一系列框架。</p><p><strong>关键术语</strong></p><ul><li>Device Policy Controller：设备政策控制器，简称 DPC</li><li>Device Owner：设备所有者，是 Android 设备管理框架运行的一种模式，有时简称为 DO</li><li>Profile Owner：工作配置所有者，是 Android 设备管理框架运行的一种模式，有时简称为 PO</li></ul><h2 id=设备管理方案>设备管理方案<a hidden class=anchor aria-hidden=true href=#设备管理方案>#</a></h2><p>一套完整的设备管理方案通常包含了两个方面的支持。其一是安装在设备端的设备政策控制器（Device Policy Controller）应用，其二是云端的控制台。企业客户在设备上安装 DPC 应用并与云端关联注册后，可以通过云端将设备管理政策下发至 DPC 应用，DPC 应用最终执行之。</p><h2 id=dpc-应用的运行模式>DPC 应用的运行模式<a hidden class=anchor aria-hidden=true href=#dpc-应用的运行模式>#</a></h2><p>Android 提供了以下三种设备管理模式，其中一种已在 9.0 后废弃，无法再使用。</p><ul><li><p>Device Owner（设备所有者）</p><p>DPC 应用成为设备所有者，用于管理整个设备。这是<strong>权限最高的模式</strong>，一旦开启，除非 DPC 应用主动注销自己，否则只能通过恢复出厂设置来重置。</p></li><li><p>Profile Owner（工作配置所有者）</p><p>DPC 应用被设置为 Profile Owner。启用这个模式后，相当于系统开启一个额外的工作分区，工作分区和个人分区的内容互不影响，DPC 应用只有管理工作分区的权限。该设备依然可以用于个人用途。此类设备管理主要用于个人和组织同时持有的设备。权限比 Device Owner 低。</p></li><li><p>Device Admin，此模式在 9.0 中被废弃并在 10.0 中完全移除相应功能。</p></li></ul><h2 id=成为device-owner>成为Device Owner<a hidden class=anchor aria-hidden=true href=#成为device-owner>#</a></h2><p>前提条件：</p><p>需要成为 Device Owner 的应用必须包含继承<code>android.app.admin.DeviceAdminReceiver</code>的组件。假设自定义的组件名为<code>TestReceiver</code>。</p><ul><li><p>通过二维码，必须在开机向导结束前设置。</p><blockquote><p>Google 没有具体提供采用这种方式激活成为 Device Owner 的详细步骤，据测试，使用下述 intent 可以启动<code>ManagedProvisioning</code>框架</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>am start -a android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE --ecn android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME <span class=s2>&#34;packageName/.TestReceiver&#34;</span>
</span></span></code></pre></div></blockquote></li><li><p>通过 adb shell</p><p>使用如下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>adb shell dpm set-device-owner packageName/.TestReceiver
</span></span></code></pre></div></li><li><p>通过 NFC</p></li></ul><h2 id=通过二维码注册为-device-owner>通过二维码注册为 Device Owner<a hidden class=anchor aria-hidden=true href=#通过二维码注册为-device-owner>#</a></h2><p>根据<a href=https://developers.google.com/android/work/play/emm-api/prov-devices>Google Play EMM API</a>，我们可以总结出通过二维码注册 Device Owner 的主要流程。</p><h3 id=准备二维码>准备二维码<a hidden class=anchor aria-hidden=true href=#准备二维码>#</a></h3><p>二维码的内容应当是一个采用 UTF-8 编码的 JSON 字符串，内部包含一些参数。这些参数包括：</p><p><strong>必须</strong></p><p><code>android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME</code></p><p><strong>如果未安装 DPC，则必须提供下载路径和校验码</strong></p><p><code>android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM</code></p><p><code>android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION</code></p><p>更多参数请参考上述资料。</p><p>一个可用的二维码内容的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;com.emm.android/com.emm.android.DeviceAdminReceiver&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;gJD2YwtOiWJHkSMkkIfLRlj-quNqG1fb6v100QmzM9w=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;https://path.to/dpc.apk&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;android.app.extra.PROVISIONING_SKIP_ENCRYPTION&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;android.app.extra.PROVISIONING_WIFI_SSID&#34;</span><span class=p>:</span> <span class=s2>&#34;GuestNetwork&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;dpc_company_name&#34;</span><span class=p>:</span> <span class=s2>&#34;Acme Inc.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;emm_server_url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://server.emm.biz:8787&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;another_custom_dpc_key&#34;</span><span class=p>:</span> <span class=s2>&#34;dpc_custom_value&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=扫码>扫码<a hidden class=anchor aria-hidden=true href=#扫码>#</a></h3><p>扫码模块必须是开机向导的一部分，开机向导完成后就无法通过二维码的方式设置 Device Owner。</p><p>扫码模块在解析完毕 JSON 内所有参数后，发送一个 Intent。Intent 的 action 应当是<code>DevicePolicyManager#ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE</code>，extra则携带解析 JSON 获得的参数。</p><h3 id=managedprovisioning>ManagedProvisioning<a hidden class=anchor aria-hidden=true href=#managedprovisioning>#</a></h3><p>相应的 Intent 将会启动<code>ManagedProvisioning</code>应用。如果 DPC 应用尚未安装到设备上，那么<code>ManagedProvisioning</code>会负责下载并安装 DPC 应用，前提是提供了下载路径和校验码这两个关键参数。</p><p>当应用已安装到设备上，<code>ManagedProvisioning</code>接下来的行为与 Android 版本相关。我们只讨论 Android 10 及以上的平台版本。</p><p>在 Android 10 及以上的平台版本，<code>ManagedProvisioning</code>将会交由 DPC 应用来决定（实际上是要求用户决定）成为 Device Owner 还是 Profile Owner。<code>ManagedProvisioning</code>将会进行一次<code>startActivityForResult</code>，ACTION 为<code>DevicePolicyManager#ACTION_GET_PROVISIONING_MODE</code>。</p><h3 id=dpc应用>DPC应用<a hidden class=anchor aria-hidden=true href=#dpc应用>#</a></h3><p>一般来说收到 Intent 后，DPC 应用应该展示一个界面，让用户选择 DPC 应用成为 Device Owner 或 Profile Owner ，结果回传的 key 可以参阅<code>DevicePolicyManager#ACTION_GET_PROVISIONING_MODE</code>的文档。</p><h3 id=最后的步骤>最后的步骤<a hidden class=anchor aria-hidden=true href=#最后的步骤>#</a></h3><p><code>ManagedProvisioning</code>将会完成使能 Device Owner 或 Profile Owner 的最后步骤。</p><p>设备配置后，DPC 会收到以下这些广播：</p><ul><li>DeviceAdminReceiver#ACTION_READY_FOR_USER_INITIALIZATION</li><li>DeviceAdminReceiver#ACTION_PROFILE_PROVISIONING_COMPLETE</li></ul><p>并且 DPC 的 <code>DevicePolicyManager#ACTION_ADMIN_POLICY_COMPLIANCE</code> 处理程序会被启动。</p><hr><p><strong>低平台版本的行为</strong></p><p>在 Android 9 及以下的平台版本，<code>ManagedProvisioning</code>将会自动判断到底将 DPC 应用设置为 Device Owner 还是 Profile Owner。判断的依据是<code>ProvisioningParams#provisioningAction</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/preprovisioning/PreProvisioningController.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Android 9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isProfileOwnerProvisioning</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// mParams类型为ProvisioningParams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mUtils</span><span class=p>.</span><span class=na>isProfileOwnerAction</span><span class=p>(</span><span class=n>mParams</span><span class=p>.</span><span class=na>provisioningAction</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/common/Utils.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Android 9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isProfileOwnerAction</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_PROFILE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_USER</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>action</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isDeviceOwnerAction</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_DEVICE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>action</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_SHAREABLE_DEVICE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>action</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这个 ACTION 一般来说和启动它的 Intent 的 ACTION 一致，但有几个特殊的 ACTION 会被转换，<code>ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE</code>就是其中一例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// packages/apps/ManagedProvisioning/src/com/android/managedprovisioning/common/Utils.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Android 9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>mapIntentToDpmAction</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalProvisioningArgumentException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getAction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dpmProvisioningAction</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ACTION_PROVISION_MANAGED_DEVICE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>因此，启动 DPC 应用这一步将被省略，并且也不会发送ACTION 为<code>DevicePolicyManager#ACTION_ADMIN_POLICY_COMPLIANCE</code> 的 Intent。</p><h2 id=流程梳理>流程梳理<a hidden class=anchor aria-hidden=true href=#流程梳理>#</a></h2><p>我们的主要分析目标是<code>ManagedProvisioning</code>这个应用，它是 AOSP 的一部分，与设备管理功能强关联。</p><h3 id=开始>开始<a hidden class=anchor aria-hidden=true href=#开始>#</a></h3><p>流程的第一步是发送一个 Intent 以启动<code>ManagedProvisioning</code>，ACTION 有四种选择，这些ACTION 均可在<code>DevicePolicyManager</code>中被找到：</p><ul><li>android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE</li><li>android.app.action.PROVISION_FINANCED_DEVICE</li><li>android.app.action.PROVISION_MANAGED_PROFILE</li><li>android.app.action.PROVISION_MANAGED_DEVICE</li></ul><p>这四个 ACTION 到底有什么区别呢？主要的区别在于，前两个 ACTION 是给系统应用使用的；后两个 ACTION 是给 DPC 应用使用的，但在 API 31 （Android 12）及以后，<code>PROVISION_MANAGED_DEVICE</code>被弃用了。DPC 应用现在只能主动成为 Profile Owner，<code>ManagedProvisioning</code>虽然还会响应<code>PROVISION_MANAGED_DEVICE</code> ，但是添加了一个条件分支阻止进一步使能为 DO。</p><p>携带的 extra 参数的要求可以参考相应 ACTION 的文档。一般来说都需要携带<code>android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME</code>这个参数来指明组件。</p><p>测试脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>am start -a android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE --ecn android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME <span class=s2>&#34;com.afwsamples.testdpc/.DeviceAdminReceiver&#34;</span>
</span></span></code></pre></div><h3 id=preprovisioningactivity>PreProvisioningActivity<a hidden class=anchor aria-hidden=true href=#preprovisioningactivity>#</a></h3><p>从清单中很容易能够发现，<code>PreProvisioningActivity</code>响应了<code>ACTION_PROVISION_MANAGED_PROFILE</code>和<code>ACTION_PROVISION_MANAGED_DEVICE</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;activity</span>
</span></span><span class=line><span class=cl>    <span class=na>android:name=</span><span class=s>&#34;.preprovisioning.PreProvisioningActivity&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:excludeFromRecents=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:immersive=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:launchMode=</span><span class=s>&#34;singleTop&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:exported=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:theme=</span><span class=s>&#34;@style/SudThemeGlifV3.DayNight&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;intent-filter</span> <span class=na>android:priority=</span><span class=s>&#34;10&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;android.app.action.PROVISION_MANAGED_PROFILE&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;android.app.action.PROVISION_MANAGED_DEVICE&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.category.DEFAULT&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/intent-filter&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/activity&gt;</span>
</span></span></code></pre></div><p>但其实不太容易发现这个 Activity 同时还响应了前面所提到的其他 ACTION，清单中定义了一个不太常见的别名结构，根据注释来看，这个别名添加了一个 system 应用才能申请的权限，主要是为了限制这两个 ACTION 只给特权应用使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!--
</span></span></span><span class=line><span class=cl><span class=c>    Trusted app entry for device owner provisioning, protected by a permission so only
</span></span></span><span class=line><span class=cl><span class=c>    privileged app can trigger this.
</span></span></span><span class=line><span class=cl><span class=c>--&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;activity-alias</span>
</span></span><span class=line><span class=cl>    <span class=na>android:name=</span><span class=s>&#34;.PreProvisioningActivityViaTrustedApp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:targetActivity=</span><span class=s>&#34;.preprovisioning.PreProvisioningActivity&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:permission=</span><span class=s>&#34;android.permission.DISPATCH_PROVISIONING_MESSAGE&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:exported=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;intent-filter</span> <span class=na>android:priority=</span><span class=s>&#34;10&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;android.app.action.PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;action</span> <span class=na>android:name=</span><span class=s>&#34;android.app.action.PROVISION_FINANCED_DEVICE&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;category</span> <span class=na>android:name=</span><span class=s>&#34;android.intent.category.DEFAULT&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/intent-filter&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/activity-alias&gt;</span>
</span></span></code></pre></div><p><code>PreProvisioningActivity</code>对 Intent 参数处理的初始化逻辑大部分位于<code>PreProvisioningActivityController#initiateProvisioning</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initiateProvisioning</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 尝试将Intent中携带的参数解析为ProvisioningParams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 解析通过ViewModel转接到Parser, 因此下文会从ViewModel中获取解析好的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tryParseParameters</span><span class=p>(</span><span class=n>intent</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ProvisioningParams</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mViewModel</span><span class=p>.</span><span class=na>getParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查是否存在不允许恢复出厂设置的保护</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>checkFactoryResetProtection</span><span class=p>(</span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查CallerPackage是否合法，这里阻止了非DPC应用发送PROVISION_MANAGED_DEVICE和PROVISION_MANAGED_PROFILE这两个ACTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>verifyActionAndCaller</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Check whether provisioning is allowed for the current action. This check needs to happen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// before any actions that might affect the state of the device.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Note that checkDevicePolicyPreconditions takes care of calling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// showProvisioningErrorAndClose. So we only need to show the factory reset dialog (if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// applicable) and return.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 重要函数, 实际上调用了DevicePolicyManager#checkProvisioningPreCondition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查是否真的可以启用设备管理功能</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>checkDevicePolicyPreconditions</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Android 12以后额外添加的分支，彻底阻止PROVISION_MANAGED_DEVICE这个ACTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isIntentActionValid</span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getAction</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>loge</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ACTION_PROVISION_MANAGED_DEVICE</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is no longer a supported intent action.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUi</span><span class=p>.</span><span class=na>abortProvisioning</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>checkAdminIntegratedFlowPreconditions</span><span class=p>(</span><span class=n>params</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 进入这个分支意味着不是NFC方式，也不是PROVISION_FINANCED_DEVICE这个ACTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ACTION为PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE时会进入这个分支</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>shouldShowOwnershipDisclaimerScreen</span><span class=p>(</span><span class=n>params</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 跳转到免责声明屏幕</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mUi</span><span class=p>.</span><span class=na>showOwnershipDisclaimerScreen</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这个方法有两个跳转方向, 如果DPC应用还没被下载安装,那么跳转到等待屏幕</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果DPC应用已经安装, 那么会直接向其发送Intent以确定成为DO还是PO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mUi</span><span class=p>.</span><span class=na>prepareAdminIntegratedFlow</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mViewModel</span><span class=p>.</span><span class=na>onAdminIntegratedFlowInitiated</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>isFinancedDeviceAction</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>provisioningAction</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ACTION为PROVISION_FINANCED_DEVICE时会进入这个分支</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUi</span><span class=p>.</span><span class=na>prepareFinancedDeviceFlow</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>isNfc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isProfileOwnerProvisioning</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startManagedProfileFlow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isDpcTriggeredManagedDeviceProvisioning</span><span class=p>(</span><span class=n>intent</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO(b/175678720): Fail provisioning if flow started by PROVISION_MANAGED_DEVICE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startManagedDeviceFlow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=如何使能为-owner>如何使能为 Owner<a hidden class=anchor aria-hidden=true href=#如何使能为-owner>#</a></h3><p>由于使能为 DO 或 PO 的路径之间存在不少可以共享的代码节点（比如下载和安装 DPC 应用），因此，<code>ManagedProvisioning</code>将每一个独立的节点抽象为 Task，而一个逻辑链路上需要执行的 Task 以及其先后顺序由一个抽象的 Controller 来控制，这些 Controller 又由一个静态工厂来根据<code>ProvisioningParams</code>控制初始化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ProvisioningControllerFactory.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProvisioningControllerFactory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>AbstractProvisioningController</span><span class=w> </span><span class=nf>createProvisioningController</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisioningParams</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisioningControllerCallback</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ACTION为PROVISION_MANAGED_DEVICE_FROM_TRUSTED_SOURCE时会进入这个分支</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>isDeviceOwnerAction</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>provisioningAction</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>deviceOwner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mUtils</span><span class=p>.</span><span class=na>isHeadlessSystemUserMode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>?</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>USER_SYSTEM</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>logi</span><span class=p>(</span><span class=s>&#34;Setting device owner on user: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>deviceOwner</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>DeviceOwnerProvisioningController</span><span class=p>.</span><span class=na>createInstance</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>deviceOwner</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>callback</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mUtils</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ACTION为PROVISION_FINANCED_DEVICE时会进入这个分支</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>isFinancedDeviceAction</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>provisioningAction</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>FinancedDeviceProvisioningController</span><span class=p>.</span><span class=na>createInstance</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ProfileOwnerProvisioningController</span><span class=p>.</span><span class=na>createInstance</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于<code>DeviceOwnerProvisioningController</code>来说，负责使能为 DO 的 Task 为<code>ProvisionFullyManagedDeviceTask</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProvisionFullyManagedDeviceTask</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractProvisioningTask</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=nd>@UserIdInt</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startTaskTimer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FullyManagedDeviceProvisioningParams</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildManagedDeviceProvisioningParams</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalProvisioningArgumentException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>loge</span><span class=p>(</span><span class=s>&#34;Failure provisioning managed device, failed to &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;infer the device admin component name&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>error</span><span class=p>(</span><span class=cm>/* resultCode= */</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// mDpm是DevicePolicyManager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mDpm</span><span class=p>.</span><span class=na>provisionFullyManagedDevice</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Catching all Exceptions to allow Managed Provisioning to handle any failure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// during provisioning properly and perform any necessary cleanup.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>loge</span><span class=p>(</span><span class=s>&#34;Failure provisioning device owner&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>error</span><span class=p>(</span><span class=cm>/* resultCode= */</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>FullyManagedDeviceProvisioningParams</span><span class=w> </span><span class=nf>buildManagedDeviceProvisioningParams</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@UserIdInt</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalProvisioningArgumentException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ComponentName</span><span class=w> </span><span class=n>adminComponent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>inferDeviceAdminComponentName</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mUtils</span><span class=p>,</span><span class=w> </span><span class=n>mContext</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FullyManagedDeviceProvisioningParams</span><span class=p>.</span><span class=na>Builder</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>adminComponent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mContext</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getString</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>R</span><span class=p>.</span><span class=na>string</span><span class=p>.</span><span class=na>default_owned_device_username</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setLeaveAllSystemAppsEnabled</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>leaveAllSystemAppsEnabled</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setTimeZone</span><span class=p>(</span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>timeZone</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setLocalTime</span><span class=p>(</span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>localTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setLocale</span><span class=p>(</span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>locale</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The device owner can grant sensors permissions if it has not opted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// out of controlling them.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setDeviceOwnerCanGrantSensorsPermissions</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>!</span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>deviceOwnerPermissionGrantOptOut</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于<code>FinancedDeviceProvisioningController</code>，负责使能为 DO 的 Task 为<code>SetDeviceOwnerPolicyTask</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SetDeviceOwnerPolicyTask</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractProvisioningTask</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 取出需要成为DO的组件名，一般来自我们Intent传入的参数，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果只传了包名但不明确是哪个组件, 那么这个函数会尝试找一个合适的组件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ComponentName</span><span class=w> </span><span class=n>adminComponent</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>inferDeviceAdminComponentName</span><span class=p>(</span><span class=n>mUtils</span><span class=p>,</span><span class=w> </span><span class=n>mContext</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>adminPackage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adminComponent</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 确保DPC应用已经被启用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>enableDevicePolicyApp</span><span class=p>(</span><span class=n>adminPackage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 先将相应组件注册为ActiveAdmin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setActiveAdmin</span><span class=p>(</span><span class=n>adminComponent</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 将DPC注册为DO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setDeviceOwner</span><span class=p>(</span><span class=n>adminComponent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mContext</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getString</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>string</span><span class=p>.</span><span class=na>default_owned_device_username</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果ACTION的类型和分期付款相关，会修改DeviceOwner的类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>success</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mUtils</span><span class=p>.</span><span class=na>isFinancedDeviceAction</span><span class=p>(</span><span class=n>mProvisioningParams</span><span class=p>.</span><span class=na>provisioningAction</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mDevicePolicyManager</span><span class=p>.</span><span class=na>setDeviceOwnerType</span><span class=p>(</span><span class=n>adminComponent</span><span class=p>,</span><span class=w> </span><span class=n>DEVICE_OWNER_TYPE_FINANCED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>loge</span><span class=p>(</span><span class=s>&#34;Failure setting device owner&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>error</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>setDeviceOwner</span><span class=p>(</span><span class=n>ComponentName</span><span class=w> </span><span class=n>component</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>owner</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProvisionLogger</span><span class=p>.</span><span class=na>logd</span><span class=p>(</span><span class=s>&#34;Setting &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>component</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; as device owner of user &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=o>+</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>component</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mUtils</span><span class=p>.</span><span class=na>getCurrentDeviceOwnerComponentName</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mDevicePolicyManager</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 关键函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mDevicePolicyManager</span><span class=p>.</span><span class=na>setDeviceOwner</span><span class=p>(</span><span class=n>component</span><span class=p>,</span><span class=w> </span><span class=n>owner</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://usagisang.github.io/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://usagisang.github.io/posts/android-framework%E4%B8%8Ejni/><span class=title>« 上一页</span><br><span>Android Framework与JNI</span>
</a><a class=next href=https://usagisang.github.io/posts/android%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E4%BF%AE%E6%94%B9%E6%8C%87%E5%8D%97/><span class=title>下一页 »</span><br><span>Android开机动画修改指南</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on x" href="https://x.com/intent/tweet/?text=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86&amp;url=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f&amp;hashtags=android"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f&amp;title=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86&amp;summary=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86&amp;source=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f&title=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on whatsapp" href="https://api.whatsapp.com/send?text=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86%20-%20https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on telegram" href="https://telegram.me/share/url?text=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86&amp;url=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android上的设备管理 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Android%e4%b8%8a%e7%9a%84%e8%ae%be%e5%a4%87%e7%ae%a1%e7%90%86&u=https%3a%2f%2fusagisang.github.io%2fposts%2fandroid%25E4%25B8%258A%25E7%259A%2584%25E8%25AE%25BE%25E5%25A4%2587%25E7%25AE%25A1%25E7%2590%2586%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=comments-container class=comments-container><br><hr style=border-color:#dfdfdf3d><section class="article discussion"><script>let currentTheme=window.localStorage.getItem("pref-theme");function loadComment(){let t=currentTheme=="dark"?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","usagisang/usagisang.github.io"),e.setAttribute("issue-term","title"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),document.getElementById("theme-toggle").onclick=async()=>{await new Promise(e=>setTimeout(e,200));let e=window.localStorage.getItem("pref-theme");e!=currentTheme&&(currentTheme=e,loadComment())}</script></section></div></article></main><footer class=footer><span>&copy; 2026 <a href=https://usagisang.github.io/>Milky Way</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>